{"version":3,"sources":["../../src/interface.js"],"names":["RookMissingToken","RookUnsupportedNodeVersion","RookInvalidToken","RookInvalidOptions","RookOldServers","require","trueValues","Rook","startSync","timeout","options","deasync","e","message","throw_errors","Error","console","error","ready","connected","start","then","catch","startTime","Date","now","loopWhile","undefined","log","self","startAttempted","Promise","resolve","reject","singleton","debug","indexOf","process","env","ROOKOUT_DEBUG","log_to_stderr","ROOKOUT_LOG_TO_STDERR","log_file","ROOKOUT_LOG_FILE","LAMBDA_TASK_ROOT","lambda_safe_start","RookIllegalLambdaStart","log_level","ROOKOUT_LOG_LEVEL","checkVersionSupported","config","_verifyBoolean","LoggingConfiguration","LOG_TO_STDERR","_verifyString","LOG_LEVEL","FILE_NAME","tags","rawTags","ROOKOUT_ROOK_TAGS","tag","split","push","StringUtils","trim","Array","isArray","labels","ROOKOUT_LABELS","label","kv","length","key","value","Map","originalLabels","Object","keys","_verifyLabel","DEBUG","git_commit","GitConfiguration","GIT_COMMIT","git_origin","GIT_ORIGIN","host","ROOKOUT_CONTROLLER_HOST","ROOKOUT_AGENT_HOST","port","ROOKOUT_CONTROLLER_PORT","ROOKOUT_AGENT_PORT","proxy","ROOKOUT_PROXY","token","ROOKOUT_TOKEN","_verifyToken","ControllerAddress","HOST","PORT","connect","stack","stop","close","flush","callback","notifyLambdaActive","context","notifyLambdaInactive","object","errorString","String","test","startsWith","RookInvalidLabel","nodeVersion","versions","version","majorVersion","parseInt","minorVersion","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nimport {StringUtils} from \"./utils\";\nimport { RookIllegalLambdaStart, RookInvalidLabel } from './exceptions'\n\nconst {RookMissingToken,\n    RookUnsupportedNodeVersion,\n    RookInvalidToken,\n    RookInvalidOptions,\n    RookOldServers} = require('./exceptions');\n\nconst trueValues = ['y', 'Y', 'yes',  'Yes',  'YES', 'true', 'True', 'TRUE', '1', true];\n\nclass Rook {\n    startSync(timeout=5000, options = {}) {\n        if (typeof timeout === 'object') {\n            options = timeout;\n            timeout = 5000;\n        }\n\n        let deasync;\n\n        try {\n            deasync = require('deasync');\n        } catch (e) {\n            const message = \"[Rookout] To use startSync, install deasync (npm install deasync)\";\n            if (options.throw_errors) {\n                throw new Error(e);\n            } else {\n                console.error(message);\n            }\n            return;\n        }\n\n        if (deasync) {\n            let ready = false;\n            let connected = false;\n            let error;\n\n            this.start(options).then(() => {\n                ready = true;\n                connected = true;\n            }).catch((e) => { ready = true; connected = false; error = e});\n\n            let startTime = Date.now();\n\n            deasync.loopWhile(() => {\n                if (timeout === undefined) {\n                    return ready === false;\n                } else {\n                    return ready === false && Date.now() <= startTime + timeout;\n                }\n            });\n\n            if (!connected) {\n                if (undefined === error) {\n                    error = new Error(\"[Rookout] Connection to Controller timed out\");\n                }\n\n                if (options.throw_errors) {\n                    throw error;\n                } else {\n                    console.log(error.message);\n                }\n            }\n        } else {\n            this.start(options);\n        }\n    }\n\n    start(options={}) {\n        let self = this;\n        this.startAttempted = true;\n\n        return new Promise((resolve, reject) => {\n            try {\n                if (self.singleton) resolve();\n\n                self.debug = false;\n\n                if (options.debug === undefined) {\n                    self.debug = trueValues.indexOf(process.env.ROOKOUT_DEBUG) !== -1;\n                } else {\n                    self.debug = options.debug;\n                }\n\n                if (options.log_to_stderr === undefined && process.env.ROOKOUT_LOG_TO_STDERR !== undefined) {\n                    options.log_to_stderr = trueValues.indexOf(process.env.ROOKOUT_LOG_TO_STDERR) !== -1;\n                }\n\n                if (options.log_file === undefined && process.env.ROOKOUT_LOG_FILE !== undefined) {\n                    options.log_file = process.env.ROOKOUT_LOG_FILE;\n                }\n\n                if (process.env.LAMBDA_TASK_ROOT) {\n                    options.log_file = \"\";\n                    if (options.lambda_safe_start !== true) {\n                        throw new RookIllegalLambdaStart();\n                    }\n                }\n\n                options.log_level = options.log_level || process.env.ROOKOUT_LOG_LEVEL;\n\n                self.throw_errors = false;\n\n                if (options.throw_errors !== undefined) {\n                    self.throw_errors = options.throw_errors;\n                }\n\n                Rook.checkVersionSupported();\n\n                const config = require('./config');\n\n                Rook._verifyBoolean(self.throw_errors, 'Rook throw errors should be a boolean');\n\n                if (options.log_to_stderr !== undefined) {\n                    Rook._verifyBoolean(options.log_to_stderr, 'Rook log to stderr should be a boolean');\n                    config.LoggingConfiguration.LOG_TO_STDERR = options.log_to_stderr;\n                }\n\n                if (options.log_level !== undefined) {\n                    Rook._verifyString(options.log_level, 'Rook log level should be a String');\n                    config.LoggingConfiguration.LOG_LEVEL = options.log_level;\n                }\n\n                if (options.log_file !== undefined) {\n                    Rook._verifyString(options.log_file, 'Rook log file should be a String');\n                    config.LoggingConfiguration.FILE_NAME = options.log_file;\n                }\n\n                if (options.tags === undefined) {\n                    let rawTags = process.env.ROOKOUT_ROOK_TAGS;\n\n                    if (rawTags !== undefined) {\n                        options.tags = [];\n\n                        for (let tag of rawTags.split(';')) {\n                            options.tags.push(StringUtils.trim(tag));\n                        }\n                    }\n                } else {\n                    if (Array.isArray(options.tags)) {\n                        for (let tag of options.tags) {\n                            Rook._verifyString(tag, 'Rook tags should be array of strings');\n                        }\n                    } else {\n                        throw new RookInvalidOptions('Rook tags should be array of strings');\n                    }\n                }\n\n                if (options.labels === undefined) {\n                    options.labels = {};\n                    let labels = process.env.ROOKOUT_LABELS;\n\n                    if (labels !== undefined) {\n                        for (let label of labels.split(',')) {\n                            let kv = label.split(':');\n                            if (kv.length === 2) {\n                                let key = kv[0];\n                                let value = kv[1];\n\n                                if (key && value) {\n                                    options.labels[key] = value;\n                                }\n                            }\n                        }\n                    }\n                } else {\n                    // Normalize the map to native dictionary\n                    if (options.labels instanceof Map){\n                        let originalLabels = options.labels;\n                        options.labels = {}\n                        for (let [key, value] of originalLabels) {\n                            options.labels[key] = value;\n                        }\n                    }\n\n                    for (let label of Object.keys(options.labels)) {\n                        Rook._verifyString(label);\n                        Rook._verifyString(options.labels[label], 'Rook label should be a map of strings');\n                        Rook._verifyLabel(label);\n                    }\n                }\n\n                Rook._verifyBoolean(self.debug, 'Rook debug flag should be a boolean');\n\n                if (self.debug) {\n                    config.LoggingConfiguration.LOG_LEVEL = 'DEBUG';\n                    config.LoggingConfiguration.LOG_TO_STDERR = true;\n                    config.LoggingConfiguration.DEBUG = true;\n                }\n\n                if (options.git_commit !== undefined) {\n                    Rook._verifyString(options.git_commit, 'Git commit should be a String');\n                    config.GitConfiguration.GIT_COMMIT = options.git_commit;\n                }\n\n                if (options.git_origin !== undefined) {\n                    Rook._verifyString(options.git_origin, 'Git origin should be a String');\n                    config.GitConfiguration.GIT_ORIGIN = options.git_origin;\n                }\n\n                let host = options.host || process.env.ROOKOUT_CONTROLLER_HOST || process.env.ROOKOUT_AGENT_HOST;\n                let port = options.port || process.env.ROOKOUT_CONTROLLER_PORT || process.env.ROOKOUT_AGENT_PORT;\n                let proxy = options.proxy || process.env.ROOKOUT_PROXY;\n                let token = options.token || process.env.ROOKOUT_TOKEN;\n\n                if (proxy !== undefined) {\n                    Rook._verifyString(proxy, 'proxy should be a string');\n                }\n\n                if (host === undefined && token === undefined) {\n                    throw new RookMissingToken();\n                } else {\n                    if (token !== undefined) {\n                        Rook._verifyToken(token);\n                    }\n                }\n\n                host = host || config.ControllerAddress.HOST;\n                Rook._verifyString(host, 'Rook host should be String');\n\n                if ((host === \"staging.cloud.agent.rookout.com\") || (host === \"cloud.agent.rookout.com\")) {\n                    throw new RookOldServers();\n                }\n\n                port = port || config.ControllerAddress.PORT;\n                if (!((typeof port === 'number') || (typeof port === 'string'))) {\n                    throw new RookInvalidOptions('Rook port should be a Number or a String');\n                }\n\n                self.singleton = require('./singleton').singleton;\n                self.singleton.connect(token, host, port, proxy, options.tags, options.labels).catch((e) => {\n                    if (self.throw_errors) {\n                        reject(e);\n                    } else {\n                        if (e instanceof RookInvalidToken || e instanceof RookOldServers || e instanceof RookIllegalLambdaStart) {\n                            console.log('[Rookout] ', e.message);\n                        } else {\n                            console.error('[Rookout] Failed to connect to the controller - will continue attempting in the background: ', e.message);\n                        }\n\n                        if (self.debug) {\n                            console.error(e.stack || e);\n                        }\n\n                        resolve(self);\n                    }\n                }).then(() => resolve(self));\n            } catch (e) {\n                if (self.throw_errors) {\n                    reject(e);\n                } else {\n                    console.error('[Rookout] Failed to start Rookout: ', e.message);\n\n                    if (self.debug) {\n                        console.error(e.stack || e);\n                    }\n\n                    resolve(self);\n                }\n            }\n        });\n    }\n\n    stop() {\n        if (!this.singleton) return;\n\n        try {\n            this.singleton.close();\n            this.singleton = undefined;\n        } catch (e) {\n            if (this.throw_errors) {\n                throw e;\n            }\n\n            if (this.debug) {\n                console.error(e.stack || e);\n            }\n        }\n    }\n\n    flush(callback) {\n        if (!this.singleton) {\n            if (callback !== undefined) {\n              callback();\n            }\n            return;\n        }\n\n        try {\n            this.singleton.flush(callback);\n        } catch (e) {\n            if (this.throw_errors) {\n                throw e;\n            }\n\n            if (this.debug) {\n                console.error(e.stack || e);\n            }\n        }\n    }\n\n    notifyLambdaActive(context) {\n        this.singleton.notifyLambdaActive(context);\n    }\n\n    notifyLambdaInactive() {\n        this.singleton.notifyLambdaInactive();\n    }\n\n    static _verifyBoolean(object, errorString) {\n        if (!(typeof object === 'boolean')) {\n            throw new RookInvalidOptions(errorString);\n        }\n    };\n\n    static _verifyString(object, errorString) {\n        if (!(typeof object === 'string' || object instanceof String)) {\n            throw new RookInvalidOptions(errorString);\n        }\n    };\n\n    static _verifyToken(object) {\n        Rook._verifyString(object, 'Rookout token should be a String');\n\n        if (object.length !== 64) {\n            throw new RookInvalidOptions('Rookout token should be 64 characters');\n        }\n\n        if (/^[0-9a-zA-Z]+$/.test(object) === false) {\n            throw new RookInvalidOptions('Rookout token must consist of only hexadecimal characters')\n        }\n    };\n\n    static _verifyLabel(label) {\n        if (label.startsWith(\"$\")) {\n            throw new RookInvalidLabel(label);\n        }\n    }\n\n    static checkVersionSupported(){\n        let nodeVersion = process.versions[\"node\"];\n        let version = nodeVersion.split(\".\");\n        let majorVersion = parseInt(version[0]);\n        let minorVersion = parseInt(version[1]);\n\n        switch (majorVersion) {\n            case 8:\n                // There's a bug in 8.9.1; https://github.com/nodejs/node/issues/16949\n                if (minorVersion === 9 && nodeVersion.startsWith(\"8.9.1\")){\n                    throw new RookUnsupportedNodeVersion(process.version);\n                }\n            case 10:\n                break;\n            case 11:\n                break;\n            case 12:\n                break;\n            default:\n                throw new RookUnsupportedNodeVersion(process.version);\n        }\n    }\n}\n\nmodule.exports = Rook;\n"],"file":"interface.js"}